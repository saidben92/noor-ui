<div id="feedback-sidebar">
  <h3>Pilot Feedback</h3>
  <p id="status-text">Waiting for Noor's response...</p>
  <div id="feedback-controls" style="display:none;">
    <button onclick="sendFeedback(1)">üëç Helpful</button>
    <button onclick="sendFeedback(-1)">üëé Unhelpful</button>
  </div>
</div>

<script type="module">
  import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed@latest/dist/web.js";

  let lastData = { question: "", answer: "", traceId: "" };

  Chatbot.initFull({
    chatflowid: "18d7b8e4-c497-4dfa-8610-bc0cac7762ad",
    apiHost: "https://noor-flowise-cloud-production.up.railway.app",
    observersConfig: {
      observeMessages: (messages) => {
        const last = messages[messages.length - 1];
        if (last.type === "userMessage") lastData.question = last.content;
        if (last.type === "apiMessage") {
          lastData.answer = last.content;
          lastData.traceId = last.id;
          // Show the feedback buttons now that we have an answer
          document.getElementById("feedback-controls").style.display = "block";
          document.getElementById("status-text").innerText = "Rate the last response:";
        }
      }
    }
  });

  window.sendFeedback = async (rating) => {
    const comment = prompt("Why this rating? (Optional)");
    const payload = { ...lastData, rating, comment };
    
    // Call your Google App Script
    await fetch("YOUR_SHEETS_ENDPOINT", {
      method: "POST",
      mode: "no-cors", 
      body: JSON.stringify(payload)
    });

    document.getElementById("feedback-controls").style.display = "none";
    document.getElementById("status-text").innerText = "Feedback sent! Continue chatting.";
  };
</script>
