<script type="module">
    import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js"

    Chatbot.initFull({
        chatflowid: "18d7b8e4-c497-4dfa-8610-bc0cac7762ad",
        apiHost: "https://noor-flowise-cloud-production.up.railway.app",

        theme: {
            chatWindow: {
                showTitle: true,
                title: "Noot_Testpilot_Feb26",
                welcomeMessage: "Welcome to Noor. Ask whatâ€™s on your mind.",
                backgroundColor: "#f7f5f2",
                fontSize: 16,

                feedback: {
                    enabled: true,
                    color: "#1e3a34"
                },

                starterPrompts: [
                    "What practice today could help soften my heart toward gratitude (shukr)?",
                    "How do I understand 'disease in the heart' (2:10)?",
                    "How can I guide my nafs without harshness?"
                ]
            }
        },

      observersConfig: {
    observeMessages: (messages) => {
        const lastMessage = messages[messages.length - 1];

        if (
            lastMessage &&
            lastMessage.type === "apiMessage" &&
            lastMessage.feedback
        ) {

            // Find the most recent user message
            const userMessage = [...messages]
                .reverse()
                .find(msg => msg.type === "userMessage");

            const feedbackData = {
                question: userMessage?.content || "Not found",
                answer: lastMessage.content || "",
                rating: lastMessage.feedback.rating === "thumbsUp" ? 1 : -1,
                comment: lastMessage.feedback.comment || "",
                trace_id: lastMessage.id || ""
            };

            fetch("https://script.google.com/macros/s/AKfycbwN1qCu8cl4yb_fc9-2e0-vgbTWkfmPNuW7JFEePF9MwgSd24592cWkauwVh3eMWy1XnQ/exec", {
                method: "POST",
                mode: "no-cors",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(feedbackData)
            });
        }
    }
});
</script>
